<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Deep Roots Daily - Crew Scheduler</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* ============================================
       DEEP ROOTS OPERATIONS THEME
       Forest greens & earth tones
    ============================================ */

    :root {
      /* Primary - Forest Green */
      --primary: #3A7D5C;
      --primary-dark: #2D6147;
      --primary-darkest: #1F4532;
      --primary-light: #4A9A73;

      /* Secondary - Earth/Clay */
      --secondary: #8B5A3C;
      --secondary-dark: #6B4530;
      --secondary-light: #A67B5B;

      /* Accent - Coffee/Bark */
      --accent: #5D4037;
      --accent-dark: #4A332C;
      --accent-light: #7B5B52;

      /* Neutrals */
      --background: #F8FAFB;
      --surface: #FFFFFF;
      --surface-secondary: #F3F5F7;
      --border: #E0E4E8;
      --text-primary: #212121;
      --text-secondary: #5F6368;
      --text-muted: #9AA0A6;

      /* Semantic colors */
      --success: #3A7D5C;
      --success-light: #E8F5E9;
      --warning: #A67B5B;
      --warning-light: #FFF3E0;
      --error: #C53030;
      --error-light: #FEE2E2;
      --info: #2563EB;
      --info-light: #EFF6FF;

      /* Crew colors - nature inspired */
      --crew-1: #3A7D5C;
      --crew-2: #8B5A3C;
      --crew-3: #5D4037;
      --crew-4: #2E7D32;
      --crew-5: #6D4C41;
      --crew-6: #4E7C31;
      --crew-7: #795548;
      --crew-8: #558B2F;

      /* Tag colors */
      --tag-person: #E8F5E9;
      --tag-person-border: #3A7D5C;
      --tag-leader: #FFF3E0;
      --tag-leader-border: #8B5A3C;
      --tag-manager: #EFEBE9;
      --tag-manager-border: #5D4037;
      --tag-truck: #E3F2FD;
      --tag-truck-border: #1565C0;
      --tag-equipment: #F3E5F5;
      --tag-equipment-border: #7B1FA2;
      --tag-job: #E0F2F1;
      --tag-job-border: #00796B;

      --radius: 8px;
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
      --shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background-color: var(--background);
      color: var(--text-primary);
      font-size: 14px;
      line-height: 1.5;
      min-height: 100vh;
    }

    /* ============================================
       HEADER
    ============================================ */

    .header {
      background: linear-gradient(135deg, var(--primary-darkest) 0%, var(--primary-dark) 50%, var(--primary) 100%);
      color: white;
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: var(--shadow-lg);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .logo {
      font-size: 24px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .logo-icon {
      width: 32px;
      height: 32px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .date-display {
      font-size: 16px;
      font-weight: 500;
      opacity: 0.9;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .status-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: rgba(255, 255, 255, 0.15);
      border-radius: var(--radius);
      font-size: 13px;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #4ADE80;
    }

    .status-dot.saving {
      background: #FBBF24;
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* ============================================
       BUTTONS
    ============================================ */

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 10px 20px;
      border: none;
      border-radius: var(--radius);
      font-family: inherit;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary-darkest) 0%, var(--primary-dark) 50%, var(--primary) 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(58, 125, 92, 0.4);
    }

    .btn-secondary {
      background: var(--secondary);
      color: white;
    }

    .btn-secondary:hover {
      background: var(--secondary-dark);
    }

    .btn-outline {
      background: transparent;
      border: 2px solid var(--border);
      color: var(--text-primary);
    }

    .btn-outline:hover {
      border-color: var(--primary);
      color: var(--primary);
    }

    .btn-ghost {
      background: rgba(255, 255, 255, 0.1);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .btn-ghost:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .btn-icon {
      padding: 8px;
      min-width: 36px;
      min-height: 36px;
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 12px;
    }

    .btn-lg {
      padding: 14px 28px;
      font-size: 16px;
    }

    /* ============================================
       MAIN LAYOUT
    ============================================ */

    .main-container {
      display: flex;
      min-height: calc(100vh - 68px);
    }

    .sidebar {
      width: 320px;
      background: var(--surface);
      border-right: 1px solid var(--border);
      padding: 20px;
      overflow-y: auto;
      position: sticky;
      top: 68px;
      height: calc(100vh - 68px);
    }

    .content {
      flex: 1;
      padding: 24px;
      overflow-y: auto;
    }

    /* ============================================
       SIDEBAR - TAG POOLS
    ============================================ */

    .sidebar-section {
      margin-bottom: 24px;
    }

    .sidebar-section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 2px solid var(--primary);
    }

    .sidebar-section-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .sidebar-section-count {
      background: var(--primary);
      color: white;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }

    .tag-pool {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      min-height: 40px;
      padding: 8px;
      background: var(--surface-secondary);
      border-radius: var(--radius);
      border: 2px dashed var(--border);
    }

    .tag-pool.drag-over {
      border-color: var(--primary);
      background: var(--success-light);
    }

    /* ============================================
       TAGS
    ============================================ */

    .tag {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      border-radius: 16px;
      font-size: 12px;
      font-weight: 500;
      cursor: grab;
      transition: all 0.15s ease;
      border: 1px solid;
      user-select: none;
    }

    .tag:active {
      cursor: grabbing;
    }

    .tag:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow);
    }

    .tag.dragging {
      opacity: 0.5;
    }

    .tag-person {
      background: var(--tag-person);
      border-color: var(--tag-person-border);
      color: var(--tag-person-border);
    }

    .tag-leader {
      background: var(--tag-leader);
      border-color: var(--tag-leader-border);
      color: var(--tag-leader-border);
    }

    .tag-manager {
      background: var(--tag-manager);
      border-color: var(--tag-manager-border);
      color: var(--tag-manager-border);
    }

    .tag-truck {
      background: var(--tag-truck);
      border-color: var(--tag-truck-border);
      color: var(--tag-truck-border);
    }

    .tag-equipment {
      background: var(--tag-equipment);
      border-color: var(--tag-equipment-border);
      color: var(--tag-equipment-border);
    }

    .tag-job {
      background: var(--tag-job);
      border-color: var(--tag-job-border);
      color: var(--tag-job-border);
    }

    .tag-remove {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: rgba(0, 0, 0, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      cursor: pointer;
      margin-left: 2px;
    }

    .tag-remove:hover {
      background: rgba(0, 0, 0, 0.2);
    }

    /* ============================================
       CREW CARDS
    ============================================ */

    .crews-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
      gap: 20px;
    }

    .crew-card {
      background: var(--surface);
      border-radius: 12px;
      box-shadow: var(--shadow);
      overflow: hidden;
      transition: all 0.2s ease;
      border-top: 4px solid;
    }

    .crew-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .crew-card[data-crew="1"] { border-top-color: var(--crew-1); }
    .crew-card[data-crew="2"] { border-top-color: var(--crew-2); }
    .crew-card[data-crew="3"] { border-top-color: var(--crew-3); }
    .crew-card[data-crew="4"] { border-top-color: var(--crew-4); }
    .crew-card[data-crew="5"] { border-top-color: var(--crew-5); }
    .crew-card[data-crew="6"] { border-top-color: var(--crew-6); }
    .crew-card[data-crew="7"] { border-top-color: var(--crew-7); }
    .crew-card[data-crew="8"] { border-top-color: var(--crew-8); }

    .crew-header {
      padding: 16px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--border);
    }

    .crew-number {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .crew-stats {
      display: flex;
      gap: 12px;
      font-size: 12px;
      color: var(--text-secondary);
    }

    .crew-stat {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .crew-body {
      padding: 16px 20px;
    }

    .crew-section {
      margin-bottom: 16px;
    }

    .crew-section:last-child {
      margin-bottom: 0;
    }

    .crew-section-label {
      font-size: 11px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .crew-dropzone {
      min-height: 40px;
      padding: 8px;
      background: var(--surface-secondary);
      border: 2px dashed var(--border);
      border-radius: var(--radius);
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .crew-dropzone.drag-over {
      border-color: var(--primary);
      background: var(--success-light);
    }

    .crew-dropzone-placeholder {
      color: var(--text-muted);
      font-size: 12px;
      font-style: italic;
    }

    /* ============================================
       SPECIAL SECTIONS (Absent, Out of Service)
    ============================================ */

    .special-sections {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      margin-top: 24px;
    }

    .special-card {
      background: var(--surface);
      border-radius: 12px;
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .special-card.absent {
      border-top: 4px solid var(--warning);
    }

    .special-card.out-of-service {
      border-top: 4px solid var(--error);
    }

    .special-header {
      padding: 16px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--border);
    }

    .special-title {
      font-size: 16px;
      font-weight: 600;
    }

    .special-body {
      padding: 16px 20px;
    }

    /* ============================================
       SALESMAN INPUT
    ============================================ */

    .salesman-input {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-family: inherit;
      font-size: 13px;
      transition: border-color 0.2s ease;
    }

    .salesman-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(58, 125, 92, 0.1);
    }

    /* ============================================
       ADD TAG INPUT
    ============================================ */

    .add-tag-form {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }

    .add-tag-input {
      flex: 1;
      padding: 6px 10px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-size: 12px;
      font-family: inherit;
    }

    .add-tag-input:focus {
      outline: none;
      border-color: var(--primary);
    }

    .add-tag-btn {
      padding: 6px 12px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: var(--radius);
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
    }

    .add-tag-btn:hover {
      background: var(--primary-dark);
    }

    /* ============================================
       ACTIONS BAR
    ============================================ */

    .actions-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding: 16px 20px;
      background: var(--surface);
      border-radius: 12px;
      box-shadow: var(--shadow);
    }

    .actions-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .actions-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .date-nav {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .date-nav-btn {
      width: 32px;
      height: 32px;
      border: 1px solid var(--border);
      background: var(--surface);
      border-radius: var(--radius);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .date-nav-btn:hover {
      border-color: var(--primary);
      color: var(--primary);
    }

    .current-date {
      font-size: 18px;
      font-weight: 600;
      min-width: 200px;
      text-align: center;
    }

    /* ============================================
       LOADING & TOAST
    ============================================ */

    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .loading-spinner {
      width: 48px;
      height: 48px;
      border: 4px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      padding: 16px 24px;
      background: var(--text-primary);
      color: white;
      border-radius: var(--radius);
      box-shadow: var(--shadow-lg);
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.3s ease;
      z-index: 1000;
    }

    .toast.show {
      transform: translateY(0);
      opacity: 1;
    }

    .toast.success {
      background: var(--primary);
    }

    .toast.error {
      background: var(--error);
    }

    /* ============================================
       RESPONSIVE
    ============================================ */

    @media (max-width: 1024px) {
      .sidebar {
        width: 280px;
      }

      .crews-grid {
        grid-template-columns: 1fr;
      }

      .special-sections {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 768px) {
      .main-container {
        flex-direction: column;
      }

      .sidebar {
        width: 100%;
        height: auto;
        position: relative;
        top: 0;
        border-right: none;
        border-bottom: 1px solid var(--border);
      }

      .header {
        padding: 12px 16px;
      }

      .logo {
        font-size: 18px;
      }

      .content {
        padding: 16px;
      }

      .actions-bar {
        flex-direction: column;
        gap: 12px;
      }

      .actions-left, .actions-right {
        width: 100%;
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <!-- Loading Overlay -->
  <div id="loading" class="loading-overlay">
    <div class="loading-spinner"></div>
  </div>

  <!-- Toast Notification -->
  <div id="toast" class="toast"></div>

  <!-- Header -->
  <header class="header">
    <div class="header-left">
      <div class="logo">
        <div class="logo-icon">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 2L2 7l10 5 10-5-10-5z"/>
            <path d="M2 17l10 5 10-5"/>
            <path d="M2 12l10 5 10-5"/>
          </svg>
        </div>
        Deep Roots Daily
      </div>
      <div class="date-display" id="headerDate"></div>
    </div>
    <div class="header-right">
      <div class="status-indicator">
        <div class="status-dot" id="statusDot"></div>
        <span id="statusText">Ready</span>
      </div>
      <button class="btn btn-ghost" onclick="loadYesterday()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
          <path d="M3 3v5h5"/>
        </svg>
        Load Yesterday
      </button>
      <button class="btn btn-primary" onclick="saveSchedule()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
          <polyline points="17 21 17 13 7 13 7 21"/>
          <polyline points="7 3 7 8 15 8"/>
        </svg>
        Save Schedule
      </button>
    </div>
  </header>

  <!-- Main Container -->
  <div class="main-container">
    <!-- Sidebar - Tag Pools -->
    <aside class="sidebar">
      <!-- People Pool -->
      <div class="sidebar-section">
        <div class="sidebar-section-header">
          <span class="sidebar-section-title">Team Members</span>
          <span class="sidebar-section-count" id="peopleCount">0</span>
        </div>
        <div class="tag-pool" id="peoplePool" ondrop="dropToPool(event, 'people')" ondragover="allowDrop(event)" ondragleave="leaveDrop(event)"></div>
        <form class="add-tag-form" onsubmit="addPerson(event)">
          <input type="text" class="add-tag-input" id="newPersonName" placeholder="Add person...">
          <select class="add-tag-input" id="newPersonType" style="width: 100px;">
            <option value="person">Member</option>
            <option value="crew-leader">Leader</option>
            <option value="manager">Manager</option>
          </select>
          <button type="submit" class="add-tag-btn">+</button>
        </form>
      </div>

      <!-- Trucks Pool -->
      <div class="sidebar-section">
        <div class="sidebar-section-header">
          <span class="sidebar-section-title">Trucks</span>
          <span class="sidebar-section-count" id="trucksCount">0</span>
        </div>
        <div class="tag-pool" id="trucksPool" ondrop="dropToPool(event, 'trucks')" ondragover="allowDrop(event)" ondragleave="leaveDrop(event)"></div>
        <form class="add-tag-form" onsubmit="addTruck(event)">
          <input type="text" class="add-tag-input" id="newTruckName" placeholder="Add truck...">
          <button type="submit" class="add-tag-btn">+</button>
        </form>
      </div>

      <!-- Equipment Pool -->
      <div class="sidebar-section">
        <div class="sidebar-section-header">
          <span class="sidebar-section-title">Equipment</span>
          <span class="sidebar-section-count" id="equipmentCount">0</span>
        </div>
        <div class="tag-pool" id="equipmentPool" ondrop="dropToPool(event, 'equipment')" ondragover="allowDrop(event)" ondragleave="leaveDrop(event)"></div>
        <form class="add-tag-form" onsubmit="addEquipment(event)">
          <input type="text" class="add-tag-input" id="newEquipmentName" placeholder="Add equipment...">
          <select class="add-tag-input" id="newEquipmentType" style="width: 90px;">
            <option value="machine">Machine</option>
            <option value="trailer">Trailer</option>
          </select>
          <button type="submit" class="add-tag-btn">+</button>
        </form>
      </div>

      <!-- Jobs Pool -->
      <div class="sidebar-section">
        <div class="sidebar-section-header">
          <span class="sidebar-section-title">Jobs</span>
          <span class="sidebar-section-count" id="jobsCount">0</span>
        </div>
        <div class="tag-pool" id="jobsPool" ondrop="dropToPool(event, 'jobs')" ondragover="allowDrop(event)" ondragleave="leaveDrop(event)"></div>
        <form class="add-tag-form" onsubmit="addJob(event)">
          <input type="text" class="add-tag-input" id="newJobName" placeholder="Add job...">
          <button type="submit" class="add-tag-btn">+</button>
        </form>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="content">
      <!-- Actions Bar -->
      <div class="actions-bar">
        <div class="actions-left">
          <div class="date-nav">
            <button class="date-nav-btn" onclick="changeDate(-1)">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M15 18l-6-6 6-6"/>
              </svg>
            </button>
            <span class="current-date" id="currentDate"></span>
            <button class="date-nav-btn" onclick="changeDate(1)">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 18l6-6-6-6"/>
              </svg>
            </button>
          </div>
        </div>
        <div class="actions-right">
          <button class="btn btn-outline btn-sm" onclick="clearAllCrews()">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 6h18"/>
              <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
              <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
            </svg>
            Clear All
          </button>
        </div>
      </div>

      <!-- Crews Grid -->
      <div class="crews-grid" id="crewsGrid"></div>

      <!-- Special Sections -->
      <div class="special-sections">
        <!-- Absent Today -->
        <div class="special-card absent">
          <div class="special-header">
            <span class="special-title">Absent Today</span>
            <span class="sidebar-section-count" id="absentCount">0</span>
          </div>
          <div class="special-body">
            <div class="crew-dropzone" id="absentZone" data-type="absent" ondrop="dropToSpecial(event, 'absent')" ondragover="allowDrop(event)" ondragleave="leaveDrop(event)">
              <span class="crew-dropzone-placeholder">Drag people here...</span>
            </div>
          </div>
        </div>

        <!-- Out of Service -->
        <div class="special-card out-of-service">
          <div class="special-header">
            <span class="special-title">Out of Service</span>
            <span class="sidebar-section-count" id="outOfServiceCount">0</span>
          </div>
          <div class="special-body">
            <div class="crew-dropzone" id="outOfServiceZone" data-type="outOfService" ondrop="dropToSpecial(event, 'outOfService')" ondragover="allowDrop(event)" ondragleave="leaveDrop(event)">
              <span class="crew-dropzone-placeholder">Drag trucks/equipment here...</span>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    // ============================================
    // STATE MANAGEMENT
    // ============================================

    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwV8EIR7jPTZn0bZ7Jgv3Pj-sn13q_Nz4kueZ9pppX_PGZrRbYjieUfkZWA41WLD2c/exec';

    let state = {
      currentDate: new Date(),
      tags: {
        people: [],
        trucks: [],
        equipment: [],
        jobs: []
      },
      crews: [],
      absent: [],
      outOfService: [],
      isSaving: false,
      lastUpdate: null
    };

    // Initialize 8 crews
    for (let i = 1; i <= 8; i++) {
      state.crews.push({
        number: i,
        members: [],
        vehicles: [],
        equipment: [],
        jobs: [],
        salesman: ''
      });
    }

    // ============================================
    // INITIALIZATION
    // ============================================

    document.addEventListener('DOMContentLoaded', async () => {
      updateDateDisplay();
      renderCrewCards();
      await loadCurrentState();
      hideLoading();
    });

    async function loadCurrentState() {
      try {
        const response = await fetch(SCRIPT_URL, {
          method: 'POST',
          body: JSON.stringify({ action: 'getCurrentState' })
        });

        const data = await response.json();

        if (data.error) {
          console.error('Error loading state:', data.error);
          // Use default tags
          initializeDefaultTags();
        } else {
          if (data.tags) {
            state.tags = data.tags;
          } else {
            initializeDefaultTags();
          }

          if (data.schedule) {
            applyScheduleData(data.schedule);
          }

          if (data.lastUpdate) {
            state.lastUpdate = data.lastUpdate;
            updateStatus('Last saved: ' + formatTime(data.lastUpdate));
          }
        }

        renderAllPools();
        renderAllCrews();

      } catch (error) {
        console.error('Error loading state:', error);
        initializeDefaultTags();
        renderAllPools();
      }
    }

    function initializeDefaultTags() {
      state.tags = {
        people: [
          { name: 'Jacob', type: 'crew-leader' },
          { name: 'Vern', type: 'person' },
          { name: 'Andreas', type: 'person' },
          { name: 'Jaime', type: 'person' },
          { name: 'Layne', type: 'crew-leader' },
          { name: 'Daniel', type: 'person' },
          { name: 'Nathan', type: 'person' },
          { name: 'Ben', type: 'manager' },
          { name: 'Juan Manuel', type: 'person' },
          { name: 'Juan Andreas', type: 'person' },
          { name: 'Scott', type: 'manager' },
          { name: 'Zach', type: 'person' },
          { name: 'Amador', type: 'person' },
          { name: 'Edgar', type: 'person' },
          { name: 'Alejandro', type: 'person' },
          { name: 'Hayden', type: 'person' },
          { name: 'Brandon', type: 'crew-leader' },
          { name: 'Tyler', type: 'person' },
          { name: 'Fredirico', type: 'person' },
          { name: 'Miguel', type: 'person' },
          { name: 'Andrew', type: 'person' },
          { name: 'Lupe', type: 'person' },
          { name: 'Jose I', type: 'crew-leader' },
          { name: 'Trey', type: 'manager' },
          { name: 'Ashe', type: 'manager' },
          { name: 'Dean', type: 'manager' },
          { name: 'James', type: 'manager' },
          { name: 'Dove', type: 'manager' },
          { name: 'Chase', type: 'crew-leader' },
          { name: 'Armando', type: 'person' },
          { name: 'Pulo', type: 'crew-leader' },
          { name: 'Jonathan', type: 'crew-leader' }
        ],
        trucks: [
          { name: '305 Power wagon' },
          { name: '306 plow' },
          { name: '307 Short Side' },
          { name: '308 White 350' },
          { name: '309 Power Wagon' },
          { name: '310 Silver 350' },
          { name: '701 Open Bed' },
          { name: '301 Big Metal' },
          { name: '302 Old Girl 7.3' },
          { name: '303 Wood Side' }
        ],
        equipment: [
          { name: 'SVL 75 Open', type: 'trailer' },
          { name: 'SVL 75 closed', type: 'trailer' },
          { name: 'Dingo 1000', type: 'trailer' },
          { name: 'Dingo 500', type: 'trailer' },
          { name: 'Hydro Seeder', type: 'machine' },
          { name: 'S85', type: 'machine' },
          { name: 'Vermeer', type: 'machine' },
          { name: 'Deere 319', type: 'machine' },
          { name: 'Deere 333', type: 'machine' },
          { name: 'KX 057', type: 'machine' },
          { name: 'KX 040', type: 'machine' }
        ],
        jobs: []
      };
    }

    function applyScheduleData(schedule) {
      if (schedule.crews) {
        schedule.crews.forEach(crewData => {
          const crew = state.crews.find(c => c.number === crewData.number);
          if (crew) {
            crew.members = crewData.members || [];
            crew.vehicles = crewData.vehicles || [];
            crew.equipment = crewData.equipment || [];
            crew.jobs = crewData.jobs || [];
            crew.salesman = crewData.salesman || '';
          }
        });
      }

      if (schedule.absent) {
        state.absent = schedule.absent;
      }

      if (schedule.outOfService) {
        state.outOfService = schedule.outOfService;
      }
    }

    // ============================================
    // RENDERING
    // ============================================

    function renderAllPools() {
      renderPeoplePool();
      renderTrucksPool();
      renderEquipmentPool();
      renderJobsPool();
    }

    function renderPeoplePool() {
      const pool = document.getElementById('peoplePool');
      const assigned = getAllAssignedPeople();

      const available = state.tags.people.filter(p => !assigned.includes(p.name));

      pool.innerHTML = available.map(person => createPersonTag(person, true)).join('');
      document.getElementById('peopleCount').textContent = available.length;
    }

    function renderTrucksPool() {
      const pool = document.getElementById('trucksPool');
      const assigned = getAllAssignedTrucks();

      const available = state.tags.trucks.filter(t => !assigned.includes(t.name));

      pool.innerHTML = available.map(truck => createTruckTag(truck, true)).join('');
      document.getElementById('trucksCount').textContent = available.length;
    }

    function renderEquipmentPool() {
      const pool = document.getElementById('equipmentPool');
      const assigned = getAllAssignedEquipment();

      const available = state.tags.equipment.filter(e => !assigned.includes(e.name));

      pool.innerHTML = available.map(eq => createEquipmentTag(eq, true)).join('');
      document.getElementById('equipmentCount').textContent = available.length;
    }

    function renderJobsPool() {
      const pool = document.getElementById('jobsPool');
      const assigned = getAllAssignedJobs();

      const available = state.tags.jobs.filter(j => !assigned.includes(j.name));

      pool.innerHTML = available.map(job => createJobTag(job, true)).join('');
      document.getElementById('jobsCount').textContent = available.length;
    }

    function getAllAssignedPeople() {
      const names = [];
      state.crews.forEach(crew => {
        crew.members.forEach(m => names.push(m.name));
      });
      state.absent.forEach(a => names.push(a.name));
      return names;
    }

    function getAllAssignedTrucks() {
      const names = [];
      state.crews.forEach(crew => {
        crew.vehicles.forEach(v => names.push(v));
      });
      state.outOfService.filter(o => isTruck(o.name)).forEach(o => names.push(o.name));
      return names;
    }

    function getAllAssignedEquipment() {
      const names = [];
      state.crews.forEach(crew => {
        crew.equipment.forEach(e => names.push(e));
      });
      state.outOfService.filter(o => isEquipment(o.name)).forEach(o => names.push(o.name));
      return names;
    }

    function getAllAssignedJobs() {
      const names = [];
      state.crews.forEach(crew => {
        crew.jobs.forEach(j => names.push(j));
      });
      return names;
    }

    function isTruck(name) {
      return state.tags.trucks.some(t => t.name === name);
    }

    function isEquipment(name) {
      return state.tags.equipment.some(e => e.name === name);
    }

    function createPersonTag(person, draggable = true) {
      const tagClass = person.type === 'crew-leader' ? 'tag-leader' :
                       person.type === 'manager' ? 'tag-manager' : 'tag-person';
      const icon = person.type === 'crew-leader' ? '&#9733;' :
                   person.type === 'manager' ? '&#9670;' : '';

      return `<span class="tag ${tagClass}" draggable="${draggable}"
        ondragstart="dragStart(event, 'person', '${person.name}', '${person.type}')"
        data-name="${person.name}" data-type="${person.type}">
        ${icon ? `<span>${icon}</span>` : ''}${person.name}
      </span>`;
    }

    function createTruckTag(truck, draggable = true) {
      return `<span class="tag tag-truck" draggable="${draggable}"
        ondragstart="dragStart(event, 'truck', '${truck.name}')"
        data-name="${truck.name}">
        &#128666; ${truck.name}
      </span>`;
    }

    function createEquipmentTag(eq, draggable = true) {
      return `<span class="tag tag-equipment" draggable="${draggable}"
        ondragstart="dragStart(event, 'equipment', '${eq.name}')"
        data-name="${eq.name}">
        &#9881; ${eq.name}
      </span>`;
    }

    function createJobTag(job, draggable = true) {
      return `<span class="tag tag-job" draggable="${draggable}"
        ondragstart="dragStart(event, 'job', '${job.name}')"
        data-name="${job.name}">
        &#128205; ${job.name}
      </span>`;
    }

    function renderCrewCards() {
      const grid = document.getElementById('crewsGrid');
      grid.innerHTML = state.crews.map(crew => `
        <div class="crew-card" data-crew="${crew.number}">
          <div class="crew-header">
            <span class="crew-number">Crew ${crew.number}</span>
            <div class="crew-stats">
              <span class="crew-stat" id="crew${crew.number}MemberCount">0 members</span>
            </div>
          </div>
          <div class="crew-body">
            <div class="crew-section">
              <div class="crew-section-label">Team Members</div>
              <div class="crew-dropzone" id="crew${crew.number}Members" data-crew="${crew.number}" data-type="members"
                ondrop="dropToCrew(event, ${crew.number}, 'members')" ondragover="allowDrop(event)" ondragleave="leaveDrop(event)">
                <span class="crew-dropzone-placeholder">Drag team members here...</span>
              </div>
            </div>
            <div class="crew-section">
              <div class="crew-section-label">Trucks</div>
              <div class="crew-dropzone" id="crew${crew.number}Vehicles" data-crew="${crew.number}" data-type="vehicles"
                ondrop="dropToCrew(event, ${crew.number}, 'vehicles')" ondragover="allowDrop(event)" ondragleave="leaveDrop(event)">
                <span class="crew-dropzone-placeholder">Drag trucks here...</span>
              </div>
            </div>
            <div class="crew-section">
              <div class="crew-section-label">Equipment</div>
              <div class="crew-dropzone" id="crew${crew.number}Equipment" data-crew="${crew.number}" data-type="equipment"
                ondrop="dropToCrew(event, ${crew.number}, 'equipment')" ondragover="allowDrop(event)" ondragleave="leaveDrop(event)">
                <span class="crew-dropzone-placeholder">Drag equipment here...</span>
              </div>
            </div>
            <div class="crew-section">
              <div class="crew-section-label">Jobs</div>
              <div class="crew-dropzone" id="crew${crew.number}Jobs" data-crew="${crew.number}" data-type="jobs"
                ondrop="dropToCrew(event, ${crew.number}, 'jobs')" ondragover="allowDrop(event)" ondragleave="leaveDrop(event)">
                <span class="crew-dropzone-placeholder">Drag jobs here...</span>
              </div>
            </div>
            <div class="crew-section">
              <div class="crew-section-label">Salesman / PM</div>
              <input type="text" class="salesman-input" id="crew${crew.number}Salesman"
                placeholder="Enter salesman or PM..."
                value="${crew.salesman || ''}"
                onchange="updateSalesman(${crew.number}, this.value)">
            </div>
          </div>
        </div>
      `).join('');
    }

    function renderAllCrews() {
      state.crews.forEach(crew => {
        renderCrewZone(crew.number, 'members');
        renderCrewZone(crew.number, 'vehicles');
        renderCrewZone(crew.number, 'equipment');
        renderCrewZone(crew.number, 'jobs');
        updateCrewMemberCount(crew.number);

        // Update salesman input
        const input = document.getElementById(`crew${crew.number}Salesman`);
        if (input) input.value = crew.salesman || '';
      });

      renderSpecialZone('absent');
      renderSpecialZone('outOfService');
    }

    function renderCrewZone(crewNumber, type) {
      const zone = document.getElementById(`crew${crewNumber}${type.charAt(0).toUpperCase() + type.slice(1)}`);
      if (!zone) return;

      const crew = state.crews.find(c => c.number === crewNumber);
      if (!crew) return;

      let items = [];
      if (type === 'members') {
        items = crew.members.map(m => createPersonTag(m));
      } else if (type === 'vehicles') {
        items = crew.vehicles.map(v => createTruckTag({ name: v }));
      } else if (type === 'equipment') {
        items = crew.equipment.map(e => createEquipmentTag({ name: e }));
      } else if (type === 'jobs') {
        items = crew.jobs.map(j => createJobTag({ name: j }));
      }

      if (items.length === 0) {
        zone.innerHTML = '<span class="crew-dropzone-placeholder">Drag items here...</span>';
      } else {
        zone.innerHTML = items.join('');
      }
    }

    function renderSpecialZone(type) {
      const zone = document.getElementById(type === 'absent' ? 'absentZone' : 'outOfServiceZone');
      if (!zone) return;

      const items = type === 'absent' ? state.absent : state.outOfService;

      if (items.length === 0) {
        zone.innerHTML = `<span class="crew-dropzone-placeholder">Drag ${type === 'absent' ? 'people' : 'trucks/equipment'} here...</span>`;
      } else {
        zone.innerHTML = items.map(item => {
          if (type === 'absent') {
            const person = state.tags.people.find(p => p.name === item.name) || { name: item.name, type: 'person' };
            return createPersonTag(person);
          } else {
            if (isTruck(item.name)) {
              return createTruckTag({ name: item.name });
            } else {
              return createEquipmentTag({ name: item.name });
            }
          }
        }).join('');
      }

      document.getElementById(type === 'absent' ? 'absentCount' : 'outOfServiceCount').textContent = items.length;
    }

    function updateCrewMemberCount(crewNumber) {
      const crew = state.crews.find(c => c.number === crewNumber);
      const count = crew ? crew.members.length : 0;
      document.getElementById(`crew${crewNumber}MemberCount`).textContent = `${count} member${count !== 1 ? 's' : ''}`;
    }

    // ============================================
    // DRAG AND DROP
    // ============================================

    let dragData = null;

    function dragStart(event, category, name, subtype = '') {
      dragData = { category, name, subtype };
      event.dataTransfer.effectAllowed = 'move';
      event.dataTransfer.setData('text/plain', JSON.stringify(dragData));
      event.target.classList.add('dragging');
    }

    function allowDrop(event) {
      event.preventDefault();
      event.currentTarget.classList.add('drag-over');
    }

    function leaveDrop(event) {
      event.currentTarget.classList.remove('drag-over');
    }

    function dropToCrew(event, crewNumber, zoneType) {
      event.preventDefault();
      event.currentTarget.classList.remove('drag-over');

      if (!dragData) return;

      const crew = state.crews.find(c => c.number === crewNumber);
      if (!crew) return;

      // Remove from previous location
      removeFromAll(dragData.name);

      // Add to crew
      if (zoneType === 'members' && dragData.category === 'person') {
        crew.members.push({ name: dragData.name, type: dragData.subtype || 'person' });
      } else if (zoneType === 'vehicles' && dragData.category === 'truck') {
        crew.vehicles.push(dragData.name);
      } else if (zoneType === 'equipment' && dragData.category === 'equipment') {
        crew.equipment.push(dragData.name);
      } else if (zoneType === 'jobs' && dragData.category === 'job') {
        crew.jobs.push(dragData.name);
      }

      dragData = null;
      renderAllPools();
      renderAllCrews();
    }

    function dropToSpecial(event, type) {
      event.preventDefault();
      event.currentTarget.classList.remove('drag-over');

      if (!dragData) return;

      // Remove from previous location
      removeFromAll(dragData.name);

      // Add to special zone
      if (type === 'absent' && dragData.category === 'person') {
        state.absent.push({ name: dragData.name });
      } else if (type === 'outOfService' && (dragData.category === 'truck' || dragData.category === 'equipment')) {
        state.outOfService.push({ name: dragData.name });
      }

      dragData = null;
      renderAllPools();
      renderAllCrews();
    }

    function dropToPool(event, poolType) {
      event.preventDefault();
      event.currentTarget.classList.remove('drag-over');

      if (!dragData) return;

      // Just remove from assigned locations - it will automatically appear in pool
      removeFromAll(dragData.name);

      dragData = null;
      renderAllPools();
      renderAllCrews();
    }

    function removeFromAll(name) {
      // Remove from all crews
      state.crews.forEach(crew => {
        crew.members = crew.members.filter(m => m.name !== name);
        crew.vehicles = crew.vehicles.filter(v => v !== name);
        crew.equipment = crew.equipment.filter(e => e !== name);
        crew.jobs = crew.jobs.filter(j => j !== name);
      });

      // Remove from special zones
      state.absent = state.absent.filter(a => a.name !== name);
      state.outOfService = state.outOfService.filter(o => o.name !== name);
    }

    // ============================================
    // ADD NEW TAGS
    // ============================================

    function addPerson(event) {
      event.preventDefault();
      const nameInput = document.getElementById('newPersonName');
      const typeSelect = document.getElementById('newPersonType');

      const name = nameInput.value.trim();
      if (!name) return;

      if (!state.tags.people.some(p => p.name === name)) {
        state.tags.people.push({ name, type: typeSelect.value });
        renderPeoplePool();
      }

      nameInput.value = '';
    }

    function addTruck(event) {
      event.preventDefault();
      const nameInput = document.getElementById('newTruckName');

      const name = nameInput.value.trim();
      if (!name) return;

      if (!state.tags.trucks.some(t => t.name === name)) {
        state.tags.trucks.push({ name });
        renderTrucksPool();
      }

      nameInput.value = '';
    }

    function addEquipment(event) {
      event.preventDefault();
      const nameInput = document.getElementById('newEquipmentName');
      const typeSelect = document.getElementById('newEquipmentType');

      const name = nameInput.value.trim();
      if (!name) return;

      if (!state.tags.equipment.some(e => e.name === name)) {
        state.tags.equipment.push({ name, type: typeSelect.value });
        renderEquipmentPool();
      }

      nameInput.value = '';
    }

    function addJob(event) {
      event.preventDefault();
      const nameInput = document.getElementById('newJobName');

      const name = nameInput.value.trim();
      if (!name) return;

      if (!state.tags.jobs.some(j => j.name === name)) {
        state.tags.jobs.push({ name });
        renderJobsPool();
      }

      nameInput.value = '';
    }

    // ============================================
    // ACTIONS
    // ============================================

    function updateSalesman(crewNumber, value) {
      const crew = state.crews.find(c => c.number === crewNumber);
      if (crew) {
        crew.salesman = value;
      }
    }

    function clearAllCrews() {
      if (!confirm('Clear all crew assignments?')) return;

      state.crews.forEach(crew => {
        crew.members = [];
        crew.vehicles = [];
        crew.equipment = [];
        crew.jobs = [];
        crew.salesman = '';
      });

      state.absent = [];
      state.outOfService = [];

      renderAllPools();
      renderAllCrews();
      showToast('All crews cleared', 'success');
    }

    function changeDate(delta) {
      state.currentDate.setDate(state.currentDate.getDate() + delta);
      updateDateDisplay();

      // Load schedule for new date
      loadScheduleForDate(formatDateForAPI(state.currentDate));
    }

    async function loadYesterday() {
      const yesterday = new Date();
      yesterday.setDate(yesterday.getDate() - 1);
      const dateStr = formatDateForAPI(yesterday);

      showLoading();
      updateStatus('Loading yesterday...', true);

      try {
        const response = await fetch(SCRIPT_URL, {
          method: 'POST',
          body: JSON.stringify({ action: 'getYesterday', date: dateStr })
        });

        const data = await response.json();

        if (data.error) {
          showToast(data.error, 'error');
        } else if (data.rows && data.rows.length > 0) {
          applyScheduleRows(data.rows);
          renderAllPools();
          renderAllCrews();
          showToast('Loaded yesterday\'s schedule', 'success');
        } else {
          showToast('No schedule found for yesterday', 'error');
        }

      } catch (error) {
        console.error('Error loading yesterday:', error);
        showToast('Failed to load yesterday\'s schedule', 'error');
      }

      hideLoading();
      updateStatus('Ready');
    }

    async function loadScheduleForDate(dateStr) {
      showLoading();
      updateStatus('Loading...', true);

      try {
        const response = await fetch(SCRIPT_URL, {
          method: 'POST',
          body: JSON.stringify({ action: 'getScheduleForDate', date: dateStr })
        });

        const data = await response.json();

        if (data.rows && data.rows.length > 0) {
          // Clear current assignments
          state.crews.forEach(crew => {
            crew.members = [];
            crew.vehicles = [];
            crew.equipment = [];
            crew.jobs = [];
            crew.salesman = '';
          });
          state.absent = [];
          state.outOfService = [];

          applyScheduleRows(data.rows);
          renderAllPools();
          renderAllCrews();

          if (data.timestamp) {
            state.lastUpdate = data.timestamp;
            updateStatus('Last saved: ' + formatTime(data.timestamp));
          }
        } else {
          // Clear for new day
          state.crews.forEach(crew => {
            crew.members = [];
            crew.vehicles = [];
            crew.equipment = [];
            crew.jobs = [];
            crew.salesman = '';
          });
          state.absent = [];
          state.outOfService = [];
          renderAllPools();
          renderAllCrews();
        }

      } catch (error) {
        console.error('Error loading schedule:', error);
      }

      hideLoading();
      updateStatus('Ready');
    }

    function applyScheduleRows(rows) {
      rows.forEach(row => {
        const crewNumber = parseInt(row[1]);

        if (crewNumber >= 1 && crewNumber <= 8) {
          const crew = state.crews.find(c => c.number === crewNumber);
          if (!crew) return;

          // Team members
          if (row[2]) {
            const members = row[2].split(',').map(m => m.trim()).filter(m => m);
            members.forEach(name => {
              const person = state.tags.people.find(p => p.name === name);
              crew.members.push({ name, type: person?.type || 'person' });
            });
          }

          // Crew leaders
          if (row[3]) {
            const leaders = row[3].split(',').map(l => l.trim()).filter(l => l);
            leaders.forEach(name => {
              if (!crew.members.some(m => m.name === name)) {
                crew.members.push({ name, type: 'crew-leader' });
              }
            });
          }

          // Managers
          if (row[4]) {
            const managers = row[4].split(',').map(m => m.trim()).filter(m => m);
            managers.forEach(name => {
              if (!crew.members.some(m => m.name === name)) {
                crew.members.push({ name, type: 'manager' });
              }
            });
          }

          // Trucks
          if (row[5]) {
            crew.vehicles = row[5].split(',').map(v => v.trim()).filter(v => v);
          }

          // Equipment
          if (row[6]) {
            crew.equipment = row[6].split(',').map(e => e.trim()).filter(e => e);
          }

          // Jobs
          if (row[7]) {
            crew.jobs = row[7].split(',').map(j => j.trim()).filter(j => j);
          }

          // Salesman
          crew.salesman = row[8] || '';

        } else if (row[1] === 'SUMMARY') {
          // Absent
          if (row[10]) {
            const absentNames = row[10].split(',').map(a => a.trim()).filter(a => a);
            absentNames.forEach(name => {
              state.absent.push({ name });
            });
          }

          // Out of service
          if (row[11]) {
            const oosNames = row[11].split(',').map(o => o.trim()).filter(o => o);
            oosNames.forEach(name => {
              state.outOfService.push({ name });
            });
          }
        }
      });
    }

    async function saveSchedule() {
      showLoading();
      updateStatus('Saving...', true);

      const timestamp = new Date().toLocaleString();
      const dateStr = formatDateForAPI(state.currentDate);

      // Build rows for Google Sheets
      const rows = [];

      // Header
      rows.push(['Date', 'Crew_Number', 'Team_Members', 'Crew_Leaders', 'Managers', 'Truck', 'Equipment', 'Job_Name', 'Salesman_PM', 'Last_Updated', 'Absent_Today', 'Out_Of_Service']);

      // Crew rows
      state.crews.forEach(crew => {
        const teamMembers = crew.members.filter(m => m.type === 'person').map(m => m.name).join(', ');
        const crewLeaders = crew.members.filter(m => m.type === 'crew-leader').map(m => m.name).join(', ');
        const managers = crew.members.filter(m => m.type === 'manager').map(m => m.name).join(', ');

        rows.push([
          dateStr,
          crew.number,
          teamMembers,
          crewLeaders,
          managers,
          crew.vehicles.join(', '),
          crew.equipment.join(', '),
          crew.jobs.join(', '),
          crew.salesman,
          timestamp,
          '',
          ''
        ]);
      });

      // Summary row
      rows.push([
        dateStr,
        'SUMMARY',
        '', '', '', '', '', '', '',
        timestamp,
        state.absent.map(a => a.name).join(', '),
        state.outOfService.map(o => o.name).join(', ')
      ]);

      try {
        const response = await fetch(SCRIPT_URL, {
          method: 'POST',
          body: JSON.stringify({
            values: rows,
            date: dateStr,
            tags: state.tags
          })
        });

        const data = await response.json();

        if (data.success) {
          state.lastUpdate = timestamp;
          showToast('Schedule saved successfully!', 'success');
          updateStatus('Last saved: ' + formatTime(timestamp));
        } else {
          showToast('Error saving: ' + (data.error || 'Unknown error'), 'error');
          updateStatus('Save failed');
        }

      } catch (error) {
        console.error('Error saving:', error);
        showToast('Failed to save schedule', 'error');
        updateStatus('Save failed');
      }

      hideLoading();
    }

    // ============================================
    // UI HELPERS
    // ============================================

    function updateDateDisplay() {
      const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
      const dateString = state.currentDate.toLocaleDateString('en-US', options);
      document.getElementById('headerDate').textContent = dateString;
      document.getElementById('currentDate').textContent = dateString;
    }

    function formatDateForAPI(date) {
      return date.toLocaleDateString('en-US');
    }

    function formatTime(timestamp) {
      if (!timestamp) return '';
      const date = new Date(timestamp);
      return date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
    }

    function showLoading() {
      document.getElementById('loading').style.display = 'flex';
    }

    function hideLoading() {
      document.getElementById('loading').style.display = 'none';
    }

    function updateStatus(text, saving = false) {
      document.getElementById('statusText').textContent = text;
      const dot = document.getElementById('statusDot');
      if (saving) {
        dot.classList.add('saving');
      } else {
        dot.classList.remove('saving');
      }
    }

    function showToast(message, type = 'info') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast ${type} show`;

      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }
  </script>
</body>
</html>
